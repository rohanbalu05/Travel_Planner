<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>NovaTrip AI — Itinerary & Map</title>

  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    /* ---------------------------
       Theme variables (vibrant)
       --------------------------- */
    :root{
      --bg: #f4f7fb;
      --card: #ffffff;
      --muted: #6b7280;
      --text: #0f172a;
      --accent: #06b6d4;        /* cyan */
      --primary: #2563eb;       /* deep blue */
      --success: #10b981;       /* green */
      --danger: #ef4444;        /* red */
      --glass: rgba(255,255,255,0.6);
      --shadow: 0 10px 30px rgba(16,24,40,0.07);
      --radius: 14px;           /* larger radius */
      --card-padding: 22px;
    }

    /* dark mode variables */
    :root.dark{
      --bg: #0b1220;
      --card: #071125;
      --muted: #9aa4b2;
      --text: #e6eef8;
      --accent: #2dd4bf;
      --primary: #60a5fa;
      --success: #34d399;
      --danger: #fb7185;
      --glass: rgba(10,20,30,0.45);
      --shadow: 0 8px 30px rgba(2,6,23,0.6);
    }

    /* ---------------------------
       Page layout
       --------------------------- */
    html,body{
      height:100%;
      margin:0;
      background: linear-gradient(180deg, var(--bg) 0%, rgba(255,255,255,0.02) 100%);
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color: var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    .container{
      max-width:1200px;
      margin:28px auto;
      padding:16px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 460px;
      gap:22px;
      align-items:start;
    }

    /* stack on small screens */
    @media (max-width:980px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background: linear-gradient(180deg, var(--card), var(--glass));
      border-radius: var(--radius);
      padding: var(--card-padding);
      box-shadow: var(--shadow);
      border: 1px solid rgba(0,0,0,0.03);
    }

    header{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:14px;
    }

    h1{
      margin:0;
      font-size:20px;
      letter-spacing:-0.2px;
    }

    .controls{
      display:flex;
      gap:8px;
      align-items:center;
    }

    /* form controls (rounded) */
    label{ display:block; font-size:13px; color:var(--muted); margin-bottom:6px; }
    input[type="text"], input[type="number"], input[type="email"], input[type="password"], textarea {
      width:100%;
      padding:12px 14px;
      border-radius:12px;               /* curved edges */
      border:1px solid rgba(15,23,42,0.06);
      background: transparent;
      color: var(--text);
      box-sizing:border-box;
      font-size:14px;
      outline:none;
    }
    textarea { min-height:110px; resize:vertical; border-radius:12px; }

    .row{ display:flex; gap:12px; align-items:center; }
    .col{ flex:1; }

    button{
      border: none;
      cursor:pointer;
      padding:11px 14px;
      border-radius:12px;               /* curved edges */
      font-weight:600;
      color:white;
      box-shadow: 0 6px 16px rgba(37,99,235,0.12);
      transition: transform .08s ease, box-shadow .08s ease, opacity .12s;
      font-size:14px;
    }
    button:active{ transform: translateY(1px); }

    .btn-primary{ background: linear-gradient(90deg,var(--primary),#1e40af); }
    .btn-accent{ background: linear-gradient(90deg,var(--accent), #06b6d4); box-shadow: 0 8px 20px rgba(6,182,212,0.14); }
    .btn-success{ background: linear-gradient(90deg,var(--success), #059669); box-shadow: 0 8px 20px rgba(16,185,129,0.12); }
    .btn-ghost{
      background: transparent;
      color: var(--text);
      border: 1px solid rgba(15,23,42,0.06);
      box-shadow:none;
    }

    /* itinerary block */
    .itinerary-pre{
      background: linear-gradient(180deg, rgba(250,250,250,0.9), rgba(250,250,250,0.7));
      border-radius:12px;
      padding:14px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace;
      font-size:13px;
      color: var(--text);
      line-height:1.5;
      border:1px solid rgba(15,23,42,0.04);
      max-height:480px;
      overflow:auto;
      white-space:pre-wrap;
    }
    :root.dark .itinerary-pre{
      background: linear-gradient(180deg, rgba(8,14,24,0.6), rgba(8,14,24,0.45));
      border:1px solid rgba(255,255,255,0.03);
    }

    /* map card specifics */
    #mapCard{
      display:flex;
      flex-direction:column;
      gap:12px;
      height:100%;
    }
    #map{ height:520px; border-radius:12px; border:1px solid rgba(15,23,42,0.06); }
    :root.dark #map{ border:1px solid rgba(255,255,255,0.04); }

    .route-info{ font-size:14px; color:var(--muted); }

    /* small helpers */
    .muted{ color:var(--muted); font-size:13px; }
    .spaced{ margin-top:14px; }

    .small{
      font-size:13px; padding:9px 10px; border-radius:10px;
    }

    .toggle{
      display:inline-flex;
      align-items:center;
      gap:8px;
      background:transparent;
      border-radius:999px;
      padding:6px;
      border:1px solid rgba(15,23,42,0.05);
    }

    footer.note{ margin-top:12px; font-size:13px; color:var(--muted); text-align:center; }

    /* Chat controls - make the form wider/longer and put undo next to apply */
    .chat-row { display:flex; gap:10px; margin-top:10px; align-items:center; }
    .chat-input { flex:1; min-height:80px; border-radius:12px; padding:12px 14px; font-size:14px; }
    .chat-buttons { display:flex; gap:8px; align-items:center; }
    .chat-buttons button { min-width:120px; }

    /* Flash messages */
    .flash-message {
      padding: 10px 14px;
      border-radius: 12px;
      margin-bottom: 12px;
      font-size: 14px;
      font-weight: 500;
    }
    .flash-message.success { background-color: #d1fae5; color: #065f46; }
    .flash-message.error { background-color: #fee2e2; color: #991b1b; }
    .flash-message.warning { background-color: #fef3c7; color: #92400e; }
    .flash-message.info { background-color: #dbeafe; color: #1e40af; }

    /* Sidebar for trips */
    .sidebar {
      width: 200px; /* Adjust as needed */
      padding-right: 20px;
      border-right: 1px solid rgba(15,23,42,0.06);
      margin-right: 20px;
    }
    .sidebar h3 { margin-top: 0; margin-bottom: 10px; font-size: 16px; }
    .sidebar ul { list-style: none; padding: 0; margin: 0; }
    .sidebar li { margin-bottom: 8px; }
    .sidebar a {
      display: block;
      padding: 8px 10px;
      border-radius: 8px;
      text-decoration: none;
      color: var(--text);
      background-color: rgba(0,0,0,0.02);
      transition: background-color 0.15s ease;
      font-size: 14px;
    }
    .sidebar a:hover { background-color: rgba(0,0,0,0.05); }
    .sidebar a.active { background-color: var(--primary); color: white; }
    .sidebar .delete-form { display: inline-block; margin-left: 8px; }
    .sidebar .delete-btn {
      background: none;
      border: none;
      color: var(--danger);
      font-size: 12px;
      padding: 0;
      cursor: pointer;
      opacity: 0.7;
    }
    .sidebar .delete-btn:hover { opacity: 1; }

    /* smaller screens tweak */
    @media (max-width:480px){
      .chat-buttons button { min-width:100px; font-size:13px; padding:9px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="grid">

      <!-- LEFT: form, itinerary, chat -->
      <div class="card">
        <header>
          <div>
            <h1>NovaTrip AI</h1>
            <div class="muted">Plan your trips with us</div>
          </div>

          <div class="controls">
            {% if user %}
              <span class="muted small">Welcome, {{ user.username }}!</span>
              <a href="{{ url_for('logout') }}" class="btn-ghost small">Logout</a>
            {% else %}
              <a href="{{ url_for('login') }}" class="btn-ghost small">Login</a>
              <a href="{{ url_for('register') }}" class="btn-primary small">Register</a>
            {% endif %}
            <div class="toggle" title="Toggle theme" id="themeToggle">
              <svg id="iconLight" width="16" height="16" viewBox="0 0 24 24" fill="none" style="display:none">
                <path d="M12 3v2M12 19v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="#0f172a" stroke-width="1.6" stroke-linecap="round"/>
                <circle cx="12" cy="12" r="3" stroke="#0f172a" stroke-width="1.6" fill="rgba(15,23,42,0.04)"/>
              </svg>
              <svg id="iconDark" width="16" height="16" viewBox="0 0 24 24" fill="none">
                <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" fill="#fff"></path>
              </svg>
              <span class="muted small" id="themeLabel">Dark</span>
            </div>
          </div>
        </header>

        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <div class="flash-messages">
              {% for category, message in messages %}
                <div class="flash-message {{ category }}">{{ message }}</div>
              {% endfor %}
            </div>
          {% endif %}
        {% endwith %}

        {% if user %}
          <!-- Main Itinerary Form and Content (only for logged-in users) -->
          <div style="display:flex; gap:20px;">
            <!-- Sidebar for saved trips -->
            <div class="sidebar">
              <h3>My Trips</h3>
              {% if user_trips %}
                <ul>
                  {% for trip in user_trips %}
                    <li>
                      <a href="{{ url_for('view_trip', trip_id=trip.id) }}" class="{% if current_trip and current_trip.id == trip.id %}active{% endif %}">
                        {{ trip.destination }} ({{ trip.days }} days)
                      </a>
                      <form action="{{ url_for('delete_trip', trip_id=trip.id) }}" method="post" class="delete-form" onsubmit="return confirm('Are you sure you want to delete this trip?');">
                        <button type="submit" class="delete-btn">x</button>
                      </form>
                    </li>
                  {% endfor %}
                </ul>
              {% else %}
                <div class="muted small">No trips saved yet.</div>
              {% endif %}
              <div class="spaced">
                <a href="{{ url_for('home') }}" class="btn-ghost small" style="width:100%; text-align:center;">New Itinerary</a>
              </div>
            </div>

            <!-- Main content area for itinerary generation/display -->
            <div style="flex:1;">
              <!-- form -->
              <form method="post" id="itineraryForm" style="display:block;">
                <div style="display:flex; gap:12px;">
                  <div class="col">
                    <label>Destination</label>
                    <input name="destination" id="destination" placeholder="e.g., Goa" value="{{ destination|e }}" required />
                  </div>
                  <div style="width:120px;">
                    <label>Days</label>
                    <input name="days" type="number" min="1" value="{{ days|default(3) }}" />
                  </div>
                </div>

                <div class="row spaced">
                  <div class="col">
                    <label>Budget</label>
                    <input name="budget" placeholder="e.g., 20000 INR" value="{{ budget|e }}" />
                  </div>
                  <div style="width:170px;">
                    <label>Trip type</label>
                    <input name="trip_type" placeholder="adventure, family, solo" value="{{ trip_type|e }}" />
                  </div>
                </div>

                <div class="spaced">
                  <button class="btn-primary" type="submit" style="width:100%;">Generate Itinerary</button>
                </div>
              </form>

              <!-- itinerary -->
              {% if result %}
                <div class="spaced">
                  <h3 style="margin:0 0 8px 0;">Itinerary</h3>
                  <div id="itineraryText" class="itinerary-pre">{{ result }}</div>

                  <div style="display:flex; gap:10px; margin-top:12px;">
                    <button id="downloadPdfBtn" class="btn-success" style="flex:1">Download PDF</button>
                  </div>
                </div>

                <!-- chat edit: enlarged input and undo next to apply -->
                <div class="spaced">
                  <strong>Edit itinerary with chatbot</strong>
                  <div style="margin-top:10px;">
                    <textarea id="chatInput" class="chat-input" placeholder="e.g., Add day 3 for island hopping with morning and afternoon timings"></textarea>

                    <div class="chat-row">
                      <div class="chat-buttons" style="margin-left:auto;">
                        <button id="sendChatBtn" class="btn-accent">Apply Change</button>
                        <button id="undoBtn" class="btn-ghost" style="color:var(--text);">Undo</button>
                      </div>
                    </div>

                    <div id="chatStatus" class="muted spaced"></div>
                  </div>
                </div>
              {% else %}
                <div class="spaced muted">Generate an itinerary to enable download and edits.</div>
              {% endif %}
            </div>
          </div>
        {% else %}
          <!-- Login/Register Forms (only for logged-out users) -->
          <div style="max-width:400px; margin: 40px auto;">
            {% if active_tab == 'register' %}
              <h2 style="text-align:center; margin-bottom:20px;">Register</h2>
              <form method="post" action="{{ url_for('register') }}">
                <label>Username</label>
                <input type="text" name="username" required />
                <div class="spaced">
                  <label>Email</label>
                  <input type="email" name="email" required />
                </div>
                <div class="spaced">
                  <label>Password</label>
                  <input type="password" name="password" required />
                </div>
                <div class="spaced">
                  <button class="btn-primary" type="submit" style="width:100%;">Register</button>
                </div>
                <div class="muted spaced" style="text-align:center;">
                  Already have an account? <a href="{{ url_for('login') }}" style="color:var(--primary); text-decoration:none;">Login here</a>
                </div>
              </form>
            {% else %} {# Default to login if no active_tab or active_tab is login #}
              <h2 style="text-align:center; margin-bottom:20px;">Login</h2>
              <form method="post" action="{{ url_for('login') }}">
                <label>Username</label>
                <input type="text" name="username" required />
                <div class="spaced">
                  <label>Password</label>
                  <input type="password" name="password" required />
                </div>
                <div class="spaced">
                  <button class="btn-primary" type="submit" style="width:100%;">Login</button>
                </div>
                <div class="muted spaced" style="text-align:center;">
                  Don't have an account? <a href="{{ url_for('register') }}" style="color:var(--primary); text-decoration:none;">Register here</a>
                </div>
              </form>
            {% endif %}
          </div>
        {% endif %}

        <footer class="note">Tip: Use the theme toggle to switch between Light & Dark modes.</footer>
      </div>

      <!-- RIGHT: Route Planner + Map -->
      <div id="mapCard" class="card">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div>
            <h3 style="margin:0;">Route Planner</h3>
            <div class="muted">Enter origin and destination. Use "My location" for origin.</div>
          </div>
          <div style="display:flex; gap:8px; align-items:center;">
            <button id="useMyLocBtn" class="btn-success small">My location</button>
            <button id="routeBtn" class="btn-primary small">Show Route</button>
          </div>
        </div>

        <div style="margin-top:10px;">
          <input id="originInput" placeholder="Origin (lat,lng) or address" class="small" style="width:100%; box-sizing:border-box; margin-bottom:8px; padding:10px; border-radius:12px;" />
          <input id="destInput" placeholder="Destination (lat,lng) or address" class="small" style="width:100%; box-sizing:border-box; padding:10px; border-radius:12px;" value="{{ destination|e }}" />
        </div>

        <div id="map" style="margin-top:12px;"></div>

        <div class="route-info" id="routeInfo" style="margin-top:10px;">&nbsp;</div>
      </div>

    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // ----- Theme (light/dark) -----
    const root = document.documentElement;
    const themeToggle = document.getElementById('themeToggle');
    const themeLabel = document.getElementById('themeLabel');
    const iconLight = document.getElementById('iconLight');
    const iconDark = document.getElementById('iconDark');

    function applyTheme(dark){
      if(dark){
        document.documentElement.classList.add('dark');
        themeLabel.textContent = 'Dark';
        iconLight.style.display = 'none';
        iconDark.style.display = 'block';
      } else {
        document.documentElement.classList.remove('dark');
        themeLabel.textContent = 'Light';
        iconLight.style.display = 'block';
        iconDark.style.display = 'none';
      }
      localStorage.setItem('nova_theme_dark', dark ? '1' : '0');
    }
    const stored = localStorage.getItem('nova_theme_dark');
    if(stored === null){
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      applyTheme(prefersDark);
    } else {
      applyTheme(stored === '1');
    }
    themeToggle.addEventListener('click', ()=> { applyTheme(!document.documentElement.classList.contains('dark')); });

    // ----- Map & route logic -----
    const map = L.map('map').setView([20.5937,78.9629],5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ maxZoom:19, attribution:'&copy; OpenStreetMap contributors' }).addTo(map);

    let routeLayer = null;
    let itineraryMarkers = []; // Array to hold itinerary markers
    const routeInfo = document.getElementById('routeInfo');

    const isLatLng = s => /^\s*-?\d+(\.\d+)?\s*,\s*-*-?\d+(\.\d+)?\s*$/.test(s);

    document.getElementById('useMyLocBtn')?.addEventListener('click', (ev)=>{
      ev.preventDefault();
      if(!navigator.geolocation) return alert('Geolocation not available.');
      navigator.geolocation.getCurrentPosition((pos)=>{
        const lat = pos.coords.latitude.toFixed(6), lon = pos.coords.longitude.toFixed(6);
        document.getElementById('originInput').value = `${lat},${lon}`;
      }, (err)=> alert('Location error: ' + err.message), { timeout:8000 });
    });

    // format duration (seconds -> "Xh Ym")
    function formatDuration(seconds){
      if(!seconds || isNaN(seconds)) return '';
      const mins = Math.round(seconds/60);
      const h = Math.floor(mins/60);
      const m = mins%60;
      return h>0 ? `${h}h ${m}m` : `${m} min`;
    }

    async function showRoute(){
      const originRaw = document.getElementById('originInput').value.trim();
      const destRaw = document.getElementById('destInput').value.trim();
      if(!destRaw) return alert('Please enter a destination.');
      if(!originRaw){
        if(confirm('No origin provided. Use browser location?')) { document.getElementById('useMyLocBtn').click(); return; } else return;
      }
      const params = new URLSearchParams();
      if(isLatLng(originRaw)) params.set('origin', originRaw); else params.set('origin_address', originRaw);
      if(isLatLng(destRaw)) params.set('dest', destRaw); else params.set('dest_address', destRaw);

      routeInfo.textContent = 'Loading route...';
      try {
        const res = await fetch('/route?' + params.toString());
        if(!res.ok){
          const p = await res.json().catch(()=>({error:res.statusText}));
          throw new Error(p.error || res.statusText);
        }
        const feature = await res.json();
        if(routeLayer) map.removeLayer(routeLayer);
        routeLayer = L.geoJSON(feature, { style:{ weight:5, opacity:0.92, color: '#1e40af' } }).addTo(map);
        map.fitBounds(routeLayer.getBounds(), { padding:[24,24] });
        const km = (feature.properties.distance/1000).toFixed(2);
        const dur = formatDuration(feature.properties.duration || 0);
        routeInfo.textContent = `Distance: ${km} km — Time: ${dur}`;
      } catch(err){
        console.error(err);
        routeInfo.textContent = 'Error: ' + err.message;
        alert('Route error: ' + err.message);
      }
    }

    document.getElementById('routeBtn')?.addEventListener('click', (e)=>{ e.preventDefault(); showRoute(); });

    // center on destination automatically when page loads (if set)
    (function centerDestInit(){
      const destRaw = document.getElementById('destInput')?.value.trim();
      if(!destRaw) return;
      if(isLatLng(destRaw)){
        const [lat,lng] = destRaw.split(',').map(x=>parseFloat(x));
        map.setView([lat,lng], 9);
        L.marker([lat,lng]).addTo(map);
      } else {
        fetch('https://nominatim.openstreetmap.org/search?format=json&limit=1&q=' + encodeURIComponent(destRaw), { headers:{'User-Agent':'novatripai/1.0'} })
          .then(r => r.json()).then(data => {
            if(data && data[0]){ const lat=parseFloat(data[0].lat), lon=parseFloat(data[0].lon); map.setView([lat,lon],9); L.marker([lat,lon]).addTo(map); }
          }).catch(()=>{/*ignore*/});
      }
    })();

    // ----- Itinerary Map Markers Logic -----
    function clearItineraryMarkers() {
      itineraryMarkers.forEach(marker => map.removeLayer(marker));
      itineraryMarkers = [];
    }

    function addItineraryMarkers(locations) {
      if (!locations || locations.length === 0) return;

      const bounds = new L.LatLngBounds();
      locations.forEach(loc => {
        if (loc.lat && loc.lng) {
          const marker = L.marker([loc.lat, loc.lng]).addTo(map);
          marker.bindPopup(`<b>${loc.place}</b><br>Day ${loc.day}`).openPopup();
          itineraryMarkers.push(marker);
          bounds.extend([loc.lat, loc.lng]);
        }
      });

      if (bounds.isValid()) {
        map.fitBounds(bounds, { padding: [50, 50] });
      }
    }

    async function fetchAndDisplayItineraryMarkers() {
      clearItineraryMarkers(); // Clear existing markers first
      const itineraryText = document.getElementById('itineraryText')?.innerText.trim();
      if (!itineraryText) {
        console.log("No itinerary text to display markers for.");
        return;
      }

      try {
        const res = await fetch('/api/itinerary-locations');
        if (!res.ok) {
          const p = await res.json().catch(() => ({ error: res.statusText }));
          throw new Error(p.error || res.statusText);
        }
        const locations = await res.json();
        addItineraryMarkers(locations);
      } catch (err) {
        console.error('Error fetching itinerary locations:', err);
        // Optionally display a flash message or update a status div
      }
    }

    // Initial load of itinerary markers if an itinerary is present
    {% if result %}
      fetchAndDisplayItineraryMarkers();
    {% endif %}

    // ----- Download, Chat modify, Undo handlers -----
    document.getElementById('downloadPdfBtn')?.addEventListener('click', async (ev)=>{
      ev.preventDefault();
      const pre = document.getElementById('itineraryText');
      if(!pre) return alert('No itinerary to download.');
      const text = pre.innerText.trim();
      if(!text) return alert('Itinerary empty.');

      const filenameBase = (document.getElementById('destination')?.value || 'itinerary').replace(/[^A-Za-z0-9_\- ]+/g, '_').trim() || 'itinerary';

      try {
        const res = await fetch('/download_itinerary', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ itinerary_text: text, filename: filenameBase })
        });
        if(!res.ok){
          const p = await res.json().catch(()=>({error:res.statusText}));
          throw new Error(p.error || res.statusText || 'Download failed');
        }
        const blob = await res.blob();
        const contentType = res.headers.get('Content-Type') || '';
        const ext = contentType.includes('pdf') ? 'pdf' : 'txt';
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `${filenameBase}.${ext}`; document.body.appendChild(a); a.click(); a.remove();
        URL.revokeObjectURL(url);
      } catch(err){ alert('Download error: ' + (err.message || err)); }
    });

    document.getElementById('sendChatBtn')?.addEventListener('click', async (ev)=>{
      ev.preventDefault();
      const input = document.getElementById('chatInput');
      const pre = document.getElementById('itineraryText');
      const status = document.getElementById('chatStatus');
      if(!input || !pre) return alert('Chat or itinerary missing.');
      const instr = input.value.trim();
      const current = pre.innerText.trim();
      if(!instr) return alert('Write an instruction.');

      status.textContent = 'Applying changes...';
      document.getElementById('sendChatBtn').disabled = true;
      try {
        const res = await fetch('/chat_modify_structured', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ instruction: instr, current_itinerary: current })
        });
        if(!res.ok){ const p = await res.json().catch(()=>({error:res.statusText})); throw new Error(p.error || res.statusText); }
        const data = await res.json();
        let updated = null;
        if(data && typeof data === 'object') updated = data.itinerary_text || data.itinerary || null;
        if(!updated) throw new Error('No updated itinerary returned.');
        // push undo stack
        window._itinerary_undo = window._itinerary_undo || [];
        window._itinerary_undo.push(current);
        pre.innerText = updated;
        status.textContent = 'Itinerary updated.';
        input.value = '';
        fetchAndDisplayItineraryMarkers(); // Update map markers after chat modification
      } catch(err){
        console.error(err);
        status.textContent = 'Error: ' + err.message;
        alert('Chat modify error: ' + err.message);
      } finally {
        document.getElementById('sendChatBtn').disabled = false;
        setTimeout(()=>{ document.getElementById('chatStatus').textContent=''; }, 3000);
      }
    });

    document.getElementById('undoBtn')?.addEventListener('click', (e)=>{
      e.preventDefault();
      window._itinerary_undo = window._itinerary_undo || [];
      const prev = window._itinerary_undo.pop();
      if(!prev) return alert('Nothing to undo.');
      document.getElementById('itineraryText').innerText = prev;
      fetchAndDisplayItineraryMarkers(); // Update map markers after undo
    });

  </script>
</body>
</html>